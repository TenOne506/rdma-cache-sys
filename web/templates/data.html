{% extends "base.html" %}

{% block title %}数据处理 - RDMA Cache System{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <h2 class="mb-4">数据可视化与分析</h2>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">结果文件</h5>
                    <h2 id="totalResults">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">日志文件</h5>
                    <h2 id="totalLogs">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">平均命中率</h5>
                    <h2 id="avgHitRate">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">刷新</h5>
                    <button class="btn btn-primary" onclick="loadStatistics()">刷新数据</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>命中率历史趋势</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hitRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>缓存层命中率分布</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="layerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>迁移操作统计</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="migrationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let hitRateChart, layerChart, migrationChart;

function loadStatistics() {
    fetch('/api/data/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalResults').textContent = data.total_results;
            document.getElementById('totalLogs').textContent = data.total_logs;
            document.getElementById('avgHitRate').textContent = (data.avg_hit_rate * 100).toFixed(2) + '%';
        });
    
    fetch('/api/data/history')
        .then(response => response.json())
        .then(data => {
            updateCharts(data);
        });
}

function updateCharts(history) {
    if (history.length === 0) {
        document.getElementById('hitRateChart').getContext('2d').clearRect(0, 0, 0, 0);
        return;
    }
    
    const labels = history.map(h => new Date(h.time).toLocaleString());
    const l1Data = history.map(h => h.l1_hit_rate * 100);
    const l2Data = history.map(h => h.l2_hit_rate * 100);
    const l3Data = history.map(h => h.l3_hit_rate * 100);
    const overallData = history.map(h => h.overall_hit_rate * 100);
    
    // 命中率趋势图
    const ctx1 = document.getElementById('hitRateChart').getContext('2d');
    if (hitRateChart) hitRateChart.destroy();
    hitRateChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'L1命中率',
                    data: l1Data,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                },
                {
                    label: 'L2命中率',
                    data: l2Data,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                },
                {
                    label: 'L3命中率',
                    data: l3Data,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                },
                {
                    label: '总体命中率',
                    data: overallData,
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    
    // 缓存层分布（饼图）
    const ctx2 = document.getElementById('layerChart').getContext('2d');
    const last = history[history.length - 1];
    if (layerChart) layerChart.destroy();
    layerChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: ['L1', 'L2', 'L3', '未命中'],
            datasets: [{
                data: [
                    last.l1_hit_rate * 100,
                    last.l2_hit_rate * 100,
                    last.l3_hit_rate * 100,
                    (1 - last.overall_hit_rate) * 100
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(201, 203, 207, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    setInterval(loadStatistics, 30000); // 每30秒刷新一次
});
</script>
{% endblock %}

