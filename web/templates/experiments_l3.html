{% extends "base.html" %}

{% block title %}L3 按需解压/懒加载实验{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="main-content">
  <h2 class="mb-4">L3 按需解压 / 懒加载 实验</h2>

  <form id="l3Form" class="row g-3 mb-3">
    <div class="col-md-2">
      <label class="form-label">Tokens</label>
      <input type="number" class="form-control" name="tokens" value="5000" min="100" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Accesses</label>
      <input type="number" class="form-control" name="accesses" value="20000" min="1000" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Workload</label>
      <select class="form-select" name="workload">
        <option value="0">Uniform</option>
        <option value="1" selected>Zipfian</option>
        <option value="2">Sequential</option>
        <option value="3">Random Walk</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">pre_stage_ratio (0~1)</label>
      <input type="number" step="0.05" class="form-control" name="pre_ratio" value="0.5" min="0" max="1">
    </div>
    <div class="col-md-3">
      <label class="form-label">expand_window</label>
      <input type="number" class="form-control" name="expand_window" value="8" min="1">
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary" id="runBtn">运行 L3 实验</button>
      <span id="status" class="ms-3 text-info" style="display:none">正在运行...</span>
    </div>
  </form>

  <div class="mb-3">
    <h5>历史CSV（L3）</h5>
    <ul id="fileList"></ul>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3"><div class="card-header">L3 占比 热力图（pre_ratio x expand_window）</div><div class="card-body"><div id="hmL3"></div></div></div>
      <div class="card mb-3"><div class="card-header">估算带宽（MB/s） 热力图</div><div class="card-body"><div id="hmBW"></div></div></div>
    </div>
    <div class="col-md-6">
      <div class="card mb-3"><div class="card-header">平均延迟（ns） 热力图</div><div class="card-body"><div id="hmLat"></div></div></div>
      <div class="card mb-3"><div class="card-header">expand 统计（批次数 vs 平均批大小）</div><div class="card-body"><div id="expandBar"></div></div></div>
    </div>
  </div>
</div>

<script>
function loadFiles(){
  fetch('/api/experiments_l3/files').then(r=>r.json()).then(files=>{
    const ul = document.getElementById('fileList'); ul.innerHTML='';
    files.forEach(f=>{
      const li = document.createElement('li');
      li.innerHTML = `<a href="#" data-file="${f.filename}">${f.filename}</a> <small class="text-muted">${f.time}</small>`;
      li.querySelector('a').addEventListener('click', (e)=>{e.preventDefault(); loadCsv(e.target.dataset.file);});
      ul.appendChild(li);
    });
    if (files.length>0) loadCsv(files[0].filename);
  });
}

function loadCsv(filename){
  fetch('/api/experiments_l3/data?file='+encodeURIComponent(filename))
   .then(r=>r.json()).then(rows=>{ draw(rows); });
}

function uniq(arr){ return Array.from(new Set(arr)); }

function draw(rows){
  const prs = uniq(rows.map(r=>r.pre_stage_ratio)).sort((a,b)=>a-b);
  const exw = uniq(rows.map(r=>r.expand_window)).sort((a,b)=>a-b);
  const idx = {}; rows.forEach(r=>{ idx[`${r.pre_stage_ratio}|${r.expand_window}`] = r; });
  function matrix(field){
    return prs.map(p=> exw.map(e=> (idx[`${p}|${e}`] ? idx[`${p}|${e}`][field] : 0)) );
  }
  const hm1 = [{z: matrix('l3_share'), x: exw, y: prs, type:'heatmap', colorscale:'Blues'}];
  const hm2 = [{z: matrix('estimated_comm_bw_MBps'), x: exw, y: prs, type:'heatmap', colorscale:'YlGnBu'}];
  const hm3 = [{z: matrix('avg_latency_ns'), x: exw, y: prs, type:'heatmap', colorscale:'YlOrRd'}];
  const layout = {height:300, margin:{t:20}, xaxis:{title:'expand_window'}, yaxis:{title:'pre_stage_ratio'}};
  Plotly.newPlot('hmL3', hm1, layout, {displayModeBar:false});
  Plotly.newPlot('hmBW', hm2, layout, {displayModeBar:false});
  Plotly.newPlot('hmLat', hm3, layout, {displayModeBar:false});

  // expand 统计
  const x = rows.map(r=>`r${r.pre_stage_ratio}-e${r.expand_window}`);
  const y1 = rows.map(r=>r.num_expands||0);
  const y2 = rows.map(r=> (r.num_expands? (r.total_estimated_bytes? (r.total_estimated_bytes): 0):0)); // 占位，可替换为avg_expand_batch字段
  const bar1 = {x, y: y1, type:'bar', name:'num_expands'};
  Plotly.newPlot('expandBar', [bar1], {height:300, margin:{t:20}}, {displayModeBar:false});
}

document.getElementById('l3Form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = new FormData(this);
  const status = document.getElementById('status'); status.style.display='inline'; status.textContent='正在运行...';
  fetch('/api/experiments_l3/run', {method:'POST', body: form}).then(r=>r.json()).then(res=>{
    setTimeout(()=>{ status.style.display='none'; loadFiles(); }, 8000);
  });
});

loadFiles();
</script>
{% endblock %}
