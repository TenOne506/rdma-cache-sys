{% extends "base.html" %}

{% block title %}三层缓存拓扑 - RDMA Cache System{% endblock %}

{% block content %}
<div class="main-content">
  <h2 class="mb-4">三层缓存拓扑</h2>
  <p class="text-muted">展示 L1 / L2 / L3 层级关系、命中占比与平均延迟（取最近一次结果）。</p>

  <div class="d-flex justify-content-center mb-3">
    <svg id="topo" width="800" height="300">
      <!-- L1 -->
      <rect x="50" y="80" width="180" height="120" rx="10" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>
      <text x="140" y="105" text-anchor="middle" font-weight="bold">L1 (NIC SRAM)</text>
      <text id="l1val" x="140" y="140" text-anchor="middle">share: -</text>

      <!-- L2 -->
      <rect x="310" y="80" width="180" height="120" rx="10" fill="#e8f5e9" stroke="#4caf50" stroke-width="2"/>
      <text x="400" y="105" text-anchor="middle" font-weight="bold">L2 (CXL.mem)</text>
      <text id="l2val" x="400" y="140" text-anchor="middle">share: -</text>

      <!-- L3 -->
      <rect x="570" y="80" width="180" height="120" rx="10" fill="#fff3e0" stroke="#ff9800" stroke-width="2"/>
      <text x="660" y="105" text-anchor="middle" font-weight="bold">L3 (Host DRAM)</text>
      <text id="l3val" x="660" y="140" text-anchor="middle">share: -</text>

      <!-- arrows -->
      <line x1="230" y1="140" x2="310" y2="140" stroke="#9e9e9e" stroke-width="2" marker-end="url(#arrow)"/>
      <line x1="490" y1="140" x2="570" y2="140" stroke="#9e9e9e" stroke-width="2" marker-end="url(#arrow)"/>
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L0,6 L9,3 z" fill="#9e9e9e"/>
        </marker>
      </defs>
    </svg>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card"><div class="card-body">
        <div class="d-flex justify-content-between"><span>平均延迟(ns)</span><span id="lat">-</span></div>
      </div></div>
    </div>
    <div class="col-md-8">
      <div class="card"><div class="card-body">
        <div>迁移统计（最近一次）：
          <ul class="mb-0">
            <li>L3→L2: <span id="m32">-</span></li>
            <li>L2→L1: <span id="m21">-</span></li>
            <li>L1→L2: <span id="d12">-</span></li>
            <li>L2→L3: <span id="d23">-</span></li>
          </ul>
          <small class="text-muted">文件: <span id="file">-</span></small>
        </div>
      </div></div>
    </div>
  </div>
</div>

<script>
function pct(x){ return (x*100).toFixed(2) + '%'; }
function load() {
  fetch('/api/topology/summary')
    .then(r=>r.json())
    .then(s => {
      if (s.error) return;
      document.getElementById('l1val').textContent = 'share: ' + pct(s.l1_share||0);
      document.getElementById('l2val').textContent = 'share: ' + pct(s.l2_share||0);
      document.getElementById('l3val').textContent = 'share: ' + pct(s.l3_share||0);
      document.getElementById('lat').textContent = (s.avg_latency_ns||0).toFixed(2);
      document.getElementById('m32').textContent = s.promote_l3_to_l2||0;
      document.getElementById('m21').textContent = s.promote_l2_to_l1||0;
      document.getElementById('d12').textContent = s.demote_l1_to_l2||0;
      document.getElementById('d23').textContent = s.demote_l2_to_l3||0;
      document.getElementById('file').textContent = s.file||'-';
    });
}
load();
setInterval(load, 15000);
</script>
{% endblock %}
